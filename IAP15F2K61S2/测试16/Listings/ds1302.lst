C51 COMPILER V9.01   DS1302                                                                04/30/2021 14:06:50 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN ds1302.OBJ
COMPILER INVOKED BY: D:\Software\Keil\32\C51\BIN\C51.EXE ds1302.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\ds1302.lst) TABS(2)

line level    source

   1          #include <STC15F2K60S2.H>
   2          #include<ds1302.h>
   3          #include <intrins.h>
   4          
   5          typedef unsigned char uchar;
   6          
   7          uchar code READ_RTC_ADDR[7] = {0x81, 0x83, 0x85, 0x87, 0x89, 0x8b, 0x8d}; 
   8          uchar code WRITE_RTC_ADDR[7] = {0x80, 0x82, 0x84, 0x86, 0x88, 0x8a, 0x8c};
   9          
  10          //---DS1302时钟初始化2016年5月7日星期六12点00分00秒。---//
  11          //---存储顺序是秒分时日月周年,存储格式是用BCD码---//
  12          uchar TIME[7] = {0, 0x36, 0x21, 0x17, 0x04, 0x06, 0x21};
  13          
  14          unsigned char code smgduan[19]={ 0xC0, 0xF9, 0xA4, 0xB0, 0x99, 0x92, 0x82, 0xF8, 0x80, 0x90, 0x88, 
  15          0x83, 0xC6, 0xA1, 0x86, 0x8E, 0xBF, 0x7F };
  16          //unsigned char DisplayData[18];
  17          
  18          sbit SCK=P1^7;    
  19          sbit SDA=P2^3;    
  20          sbit RST = P1^3;   // DS1302复位  
  21          
  22          void Write_Ds1302(unsigned  char temp) 
  23          {
  24   1        unsigned char i;
  25   1        for (i=0;i<8;i++)       
  26   1        { 
  27   2          SCK=0;
  28   2          SDA=temp&0x01;
  29   2          temp>>=1; 
  30   2          SCK=1;
  31   2        }
  32   1      }   
  33          
  34          void Write_Ds1302_Byte( unsigned char address,unsigned char dat )     
  35          {
  36   1        RST=0;  _nop_();
  37   1        SCK=0;  _nop_();
  38   1        RST=1;  _nop_();  
  39   1        Write_Ds1302(address);  
  40   1        Write_Ds1302(dat);    
  41   1        RST=0; 
  42   1      }
  43          
  44          unsigned char Read_Ds1302_Byte ( unsigned char address )
  45          {
  46   1        unsigned char i,temp=0x00;
  47   1        RST=0;  _nop_();
  48   1        SCK=0;  _nop_();
  49   1        RST=1;  _nop_();
  50   1        Write_Ds1302(address);
  51   1        for (i=0;i<8;i++)   
  52   1        {   
  53   2          SCK=0;
  54   2          temp>>=1; 
C51 COMPILER V9.01   DS1302                                                                04/30/2021 14:06:50 PAGE 2   

  55   2          if(SDA)
  56   2          temp|=0x80; 
  57   2          SCK=1;
  58   2        } 
  59   1        RST=0;  _nop_();
  60   1        SCK=0;  _nop_();
  61   1        SCK=1;  _nop_();
  62   1        SDA=0;  _nop_();
  63   1        SDA=1;  _nop_();
  64   1        return (temp);      
  65   1      }
  66          
  67          void Ds1302Init()
  68          {
  69   1        uchar n;
  70   1        Write_Ds1302_Byte(0x8E,0x00);    //禁止写保护，就是关闭写保护功能
  71   1        for (n=0; n<7; n++)//写入7个字节的时钟信号：分秒时日月周年
  72   1        {
  73   2          Write_Ds1302_Byte(WRITE_RTC_ADDR[n],TIME[n]); 
  74   2        }
  75   1        Write_Ds1302_Byte(0x8E,0x80);    //打开写保护功能
  76   1      }
  77          
  78          void Ds1302ReadTime()
  79          {
  80   1        uchar n;
  81   1        for (n=0; n<7; n++)//读取7个字节的时钟信号：分秒时日月周年
  82   1        {
  83   2          TIME[n] = Read_Ds1302_Byte(READ_RTC_ADDR[n]);
  84   2        }
  85   1          
  86   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    148    ----
   CONSTANT SIZE    =     33    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     25    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
