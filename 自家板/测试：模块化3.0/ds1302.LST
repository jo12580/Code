C51 COMPILER V9.01   DS1302                                                                04/28/2020 17:00:38 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN ds1302.OBJ
COMPILER INVOKED BY: C:\软件\C51\BIN\C51.EXE ds1302.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include"ds1302.h"
   2          
   3          //---DS1302写入和读取时分秒的地址命令---//
   4          //---秒分时日月周年 最低位读写位;-------//
   5          uchar code READ_RTC_ADDR[7] = {0x81, 0x83, 0x85, 0x87, 0x89, 0x8b, 0x8d}; 
   6          uchar code WRITE_RTC_ADDR[7] = {0x80, 0x82, 0x84, 0x86, 0x88, 0x8a, 0x8c};
   7          
   8          //---DS1302时钟初始化2016年5月7日星期六12点00分00秒。---//
   9          //---存储顺序是秒分时日月周年,存储格式是用BCD码---//
  10          uchar TIME[7] = {0, 0x55, 0x17, 0x29, 0x3, 0x06, 0x20};
  11          
  12          char num=0;
  13          uchar DisplayData[8] ;
  14          char code smgduan[17]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,
  15                                                          0x07,0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71}        //显示0~F的值
  16          
  17          #define GPIO_DIG P0
  18          
  19          
  20          
  21          /*******************************************************************************
  22          * 函 数 名         : Ds1302Write
  23          * 函数功能                 : 向DS1302命令（地址+数据）
  24          * 输    入         : addr,dat
  25          * 输    出         : 无
  26          *******************************************************************************/
  27          
  28          void Ds1302Write(uchar addr, uchar dat)
*** ERROR C141 IN LINE 28 OF DS1302.C: syntax error near 'void'
  29          {
*** ERROR C231 IN LINE 29 OF DS1302.C: '_Ds1302Write': redefinition
*** ERROR C141 IN LINE 29 OF DS1302.C: syntax error near '{'
  30                  uchar n;
  31                  RST = 0;
*** ERROR C231 IN LINE 31 OF DS1302.C: 'RST': redefinition
*** ERROR C231 IN LINE 31 OF DS1302.C: 'RST': redefinition
  32                  _nop_();
*** ERROR C231 IN LINE 32 OF DS1302.C: '__nop_': redefinition
  33          
  34                  SCLK = 0;//先将SCLK置低电平。
*** ERROR C231 IN LINE 34 OF DS1302.C: 'SCLK': redefinition
*** ERROR C231 IN LINE 34 OF DS1302.C: 'SCLK': redefinition
  35                  _nop_();
*** ERROR C231 IN LINE 35 OF DS1302.C: '__nop_': redefinition
  36                  RST = 1; //然后将RST(CE)置高电平。
*** ERROR C279 IN LINE 36 OF DS1302.C: 'RST': multiple initialization
*** ERROR C231 IN LINE 36 OF DS1302.C: 'RST': redefinition
*** ERROR C231 IN LINE 36 OF DS1302.C: 'RST': redefinition
  37                  _nop_();
*** ERROR C231 IN LINE 37 OF DS1302.C: '__nop_': redefinition
  38          
  39                  for (n=0; n<8; n++)//开始传送八位地址命令
*** ERROR C141 IN LINE 39 OF DS1302.C: syntax error near 'for'
*** ERROR C141 IN LINE 39 OF DS1302.C: syntax error near '=', expected ')'
*** ERROR C129 IN LINE 39 OF DS1302.C: missing ';' before '<'
C51 COMPILER V9.01   DS1302                                                                04/28/2020 17:00:38 PAGE 2   

  40                  {
  41                          DSIO = addr & 0x01;//数据从低位开始传送
  42                          addr >>= 1;
  43                          SCLK = 1;//数据在上升沿时，DS1302读取数据
  44                          _nop_();
  45                          SCLK = 0;
  46                          _nop_();
  47                  }
  48                  for (n=0; n<8; n++)//写入8位数据
  49                  {
  50                          DSIO = dat & 0x01;
  51                          dat >>= 1;
  52                          SCLK = 1;//数据在上升沿时，DS1302读取数据
  53                          _nop_();
  54                          SCLK = 0;
  55                          _nop_();        
  56                  }       
  57                           
  58                  RST = 0;//传送数据结束
  59                  _nop_();
  60          }
  61          
  62          /*******************************************************************************
  63          * 函 数 名         : Ds1302Read
  64          * 函数功能                 : 读取一个地址的数据
  65          * 输    入         : addr
  66          * 输    出         : dat
  67          *******************************************************************************/
  68          
  69          uchar Ds1302Read(uchar addr)
  70          {
  71                  uchar n,dat,dat1;
  72                  RST = 0;
  73                  _nop_();
  74          
  75                  SCLK = 0;//先将SCLK置低电平。
  76                  _nop_();
  77                  RST = 1;//然后将RST(CE)置高电平。
  78                  _nop_();
  79          
  80                  for(n=0; n<8; n++)//开始传送八位地址命令
  81                  {
  82                          DSIO = addr & 0x01;//数据从低位开始传送
  83                          addr >>= 1;
  84                          SCLK = 1;//数据在上升沿时，DS1302读取数据
  85                          _nop_();
  86                          SCLK = 0;//DS1302下降沿时，放置数据
  87                          _nop_();
  88                  }
  89                  _nop_();
  90                  for(n=0; n<8; n++)//读取8位数据
  91                  {
  92                          dat1 = DSIO;//从最低位开始接收
  93                          dat = (dat>>1) | (dat1<<7);
  94                          SCLK = 1;
  95                          _nop_();
  96                          SCLK = 0;//DS1302下降沿时，放置数据
  97                          _nop_();
  98                  }
  99          
 100                  RST = 0;
 101                  _nop_();        //以下为DS1302复位的稳定时间,必须的。
C51 COMPILER V9.01   DS1302                                                                04/28/2020 17:00:38 PAGE 3   

 102                  SCLK = 1;
 103                  _nop_();
 104                  DSIO = 0;
 105                  _nop_();
 106                  DSIO = 1;
 107                  _nop_();
 108                  return dat;     
 109          }
 110          
 111          /*******************************************************************************
 112          * 函 数 名         : Ds1302Init
 113          * 函数功能                 : 初始化DS1302.
 114          * 输    入         : 无
 115          * 输    出         : 无
 116          *******************************************************************************/
 117          
 118          void Ds1302Init()
 119          {
 120                  uchar n;
 121                  Ds1302Write(0x8E,0X00);          //禁止写保护，就是关闭写保护功能
 122                  for (n=0; n<7; n++)//写入7个字节的时钟信号：分秒时日月周年
 123                  {
 124                          Ds1302Write(WRITE_RTC_ADDR[n],TIME[n]); 
 125                  }
 126                  Ds1302Write(0x8E,0x80);          //打开写保护功能
 127          }
 128          
 129          /*******************************************************************************
 130          * 函 数 名         : Ds1302ReadTime
 131          * 函数功能                 : 读取时钟信息
 132          * 输    入         : 无
 133          * 输    出         : 无
 134          *******************************************************************************/
 135          
 136          void Ds1302ReadTime()
 137          {
 138                  uchar n;
 139                  for (n=0; n<7; n++)//读取7个字节的时钟信号：分秒时日月周年
 140                  {
 141                          TIME[n] = Ds1302Read(READ_RTC_ADDR[n]);
 142                  }
 143                          
 144          }
 145          
 146          
 147           /*******************************************************************************
 148          * 函 数 名         : datapros()
 149          * 函数功能                 : 时间读取处理转换函数
 150          * 输    入         : 无
 151          * 输    出         : 无
 152          *******************************************************************************/
 153          
 154          void datapros()          
 155          {
 156                  Ds1302ReadTime();
 157                  DisplayData[0] = smgduan[TIME[2]/16];                           //时
 158                  DisplayData[1] = smgduan[TIME[2]&0x0f];                          
 159                  DisplayData[2] = 0x40;
 160                  DisplayData[3] = smgduan[TIME[1]/16];                           //分
 161                  DisplayData[4] = smgduan[TIME[1]&0x0f]; 
 162                  DisplayData[5] = 0x40;
 163                  DisplayData[6] = smgduan[TIME[0]/16];                           //秒
C51 COMPILER V9.01   DS1302                                                                04/28/2020 17:00:38 PAGE 4   

 164          }
 165          
 166          
 167             void DigDisplay()
 168          {
 169                  u8 i;
 170                  for(i=0;i<8;i++)
 171                  {
 172                          switch(i)        //位选，选择点亮的数码管，
 173                          {
 174                                  case(0):
 175                                          LSA=1;LSB=1;LSC=1; break;//显示第7位
 176                                  case(1):
 177                                          LSA=0;LSB=1;LSC=1; break;//显示第6位
 178                                  case(2):
 179                                          LSA=1;LSB=0;LSC=1; break;//显示第5位
 180                                  case(3):
 181                                          LSA=0;LSB=0;LSC=1; break;//显示第4位
 182                                  case(4):
 183                                          LSA=1;LSB=1;LSC=0; break;//显示第3位 
 184                                  case(5):
 185                                          LSA=0;LSB=1;LSC=0; break;//显示第2位 
 186                                  case(6):
 187                                          LSA=1;LSB=0;LSC=0; break;//显示第1位    
 188                          }
 189                          P0=DisplayData[i];//发送段码
 190                          delay(100);
 191                          P0=0x00;//消隐
 192                  }
 193          }
 194          

C51 COMPILATION COMPLETE.  0 WARNING(S),  16 ERROR(S)
